#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Software is free software released under the "GNU Affero General Public License v3.0"
#
# Copyright (c) 2014       psychedelys
# Copyright (c) 2015-2019  Pieter-Jan Moreels - pieter-jan@pidgey.net
# Copyright (c) 2015-2019  Alexandre Dulaunoy - a@foo.be

# Imports
import click
import json
import urllib.parse

from cvesearch import DatabaseLayer


@click.command()
@click.argument('-s', '--search', help='search in cpe list')
@click.argument('-o', '--output', default='expanded', choices=['expanded, compact, json'], help='output format')
@click.option('-f', is_flag=True, default=False,
              help='Expand the CPE query to all CPE indices. Needs cpeother activated.')
def search_cpe(cpe, frmt, other):
    """Search for CPE with a pattern."""
    data = DatabaseLayer().CPE.get_regex(urllib.parse.quote(cpe), other)
    if frmt == 'json':
        o = [{'id': i.id, 'title': i.title} for i in data]
        click.echo(f'{json.dumps(o, sort_keys=True, indent=4)}')
    elif frmt == 'compact':
        click.echo('\n'.join([f'{i.id}' for i in data]))
    elif frmt == 'expanded':
        click.echo('\n'.join([f'{i.id}  {i.title}' for i in data]))


if __name__ == '__main__':
    click.command(search_cpe)
