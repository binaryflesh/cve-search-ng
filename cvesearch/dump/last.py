#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Dump last CVE entries in RSS 1,RSS 2 or Atom format.
#
# Software is free software released under the "GNU Affero General Public License v3.0"
#
# Copyright (c) 2012-2019  Alexandre Dulaunoy - a@foo.be
# Copyright (c) 2015-2019  Pieter-Jan Moreels - pieter-jan@pidgey.net

# Imports
import datetime
import time
import click

from .. import DatabaseLayer
from . import dump


@dump.command()
@click.pass_context
@dump.argument('-f', '--format', choices=['rss1', 'rss2', 'atom', 'html'], default='rss1', help='Output format')
@dump.argument('-l', '--last', default=10, help='Last n items.')
@dump.option('-n', '--name', default=True, help='Disable CPE name lookup')
@dump.option('-r', '--ranking', is_flag=True, help='Enable CVE ranking')
# @click.argument('-c', '--capec', is_flag=True, default=False, help='Display CAPEC values')
def dump_last(frmt, last, name, ranking):
    """Dump last CVE entries in RSSv1, RSSv2 or ATOM format."""
    ref = "http://adulau.github.com/cve-search/"

    cves = DatabaseLayer().CVE.last(limit=last, ranking=ranking)
    feed = None
    if not(frmt == "html"):
        from feedformatter import Feed
        feed = Feed()

        feed.feed['title'] = "cve-search Last " + str(last) + " CVE entries generated on " + str(datetime.datetime.now())
        feed.feed['link'] = "http://adulau.github.com/cve-search/"
        feed.feed['author'] = "Generated with cve-search available at " + ref
        feed.feed['description'] = ""
    else:
        click.echo("<html><head>")
        click.echo("<style>.cve table { border-collapse: collapse; text-align: left; width: 100%; } .cve {font: normal 12px/150% Geneva, Arial, Helvetica, sans-serif; background: #fff; overflow: hidden; border: 1px solid #006699; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; }.cve table td, .cve table th { padding: 3px 10px; }.cve table tbody td { color: #00496B; border-left: 1px solid #E1EEF4;font-size: 12px;font-weight: normal; }.cve table tbody .alt td { background: #E1EEF4; color: #00496B; }.cve table tbody td:first-child { border-left: none; }.cve table tbody tr:last-child td { border-bottom: none; }.cve table tfoot td div { border-top: 1px solid #006699;background: #E1EEF4;} .cve table tfoot td { padding: 0; font-size: 12px } .cve table tfoot td div{ padding: 0px; }</style>")
        click.echo("<title>Last " + str(last) + " CVE entries</title>")
        click.echo("</head><body>")
    for x in cves:
        if not(frmt == "html"):
            item = {}
            item['title'] = x.id + " " + x.summary[:90] + "..."
            item['description'] = x.summary
            if ranking and x.ranking:
                item['description'] = item['description'] + " Ranking:" + str(x.ranking)
            item['pubDate'] = time.localtime()
            item['guid'] = x.id
            if x.references:
                item["link"] = x.references[0]
            else:
                item["link"] = "http://web.nvd.nist.gov/view/vuln/detail?vulnId=" + x.id
            feed.items.append(item)
        else:
            click.echo("<div class=\"cve\"><table><tbody>")
            click.echo("<tr class=\"alt\">")
            click.echo("<td>" + x.id + " - " + x.summary[:90] + "...</td>")
            click.echo("</tr>")
            click.echo("<tr><td>CVSS: " + str(x.cvss) + " Published: " + str(x.published) + "</td></tr>")
            click.echo("<tr>")
            click.echo("<td> Summary: " + x.summary + "</td>")
            click.echo("</tr>")
            click.echo("<tr><td>Vulnerable configuration:</td></tr>")
            click.echo("<tr><td><ul>")
            for v in x.vulnerable_configuration:
                _name = v.name if name else v.id
                click.echo("<li>" + _name + "</li>")
            click.echo("</ul></td></tr>")
            if ranking and x.ranking:
                click.echo("<tr><td>Ranking:" + str(x.ranking) + "</td></tr>")
            click.echo("<tr><td>References:<td></tr>")
            click.echo("<tr><td><ul>")
            for r in x.references:
                click.echo("<li><a href=\"" + r + "\">" + r + "</a></li>")
            click.echo("</ul></tr></td>")
            click.echo("</tbody></table></div><br/>")
        if frmt == "rss1":
            click.echo(feed.format_rss1_string())
        elif frmt == "atom":
            click.echo(feed.format_atom_string())
        elif frmt == "html":
            click.echo("Generated with <a href=\"https://github.com/adulau/cve-search\">cve-search</a> at " + str(datetime.datetime.today()) + ".")
            click.echo("</body></html>")
        else:
            click.echo(feed.format_rss2_string())


if __name__ == '__main__':
    dump_last(input)
