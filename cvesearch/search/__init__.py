#!/usr/bin/env python3
#
# search is the search component of cve-search querying the database
#
# Software is free software released under the "GNU Affero General Public License v3.0"
#
# Copyright (c) 2012-2015  Wim Remes
# Copyright (c) 2012-2019  Alexandre Dulaunoy - a@foo.be
# Copyright (c) 2015-2019  Pieter-Jan Moreels - pieter-jan@pidgey.net

# Imports
import click

from .cpe import search_cpe
from .irc import search_irc
from .xmpp import search_xmpp
from .fulltext import search_fulltext

from .. import DatabaseLayer, Query, output


@click.command()
@click.pass_context
@click.option('-p', '--product', type=click.STRING)
# @click.argument('-f', '--fulltext', help='full text search in cve summary')
@click.argument('-c', '--cve', type=click.STRING, multi=True)
@click.option('-o', '--output', type=click.STRING, choices=['csv', 'html', 'json', 'xml', 'cveid', 'asciidoc'])
# @click.argument('-l', '--descending', is_flag=True, help='sort in descending mode')
@click.option('-n', '--cpe', type=click.BOOL)
@click.option('-r', '--ranking', type=click.BOOL)
@click.option('-a', '--capec', type=click.BOOL)
# @click.argument('-v', '--vendor', help='vendor name to lookup in reference urls')
@click.option('--api', type=click.STRING)
def search(product, cve, frmt, cpe, rank, capec, api):
    """Search for vulnerabilities in the Nat'l Vulnerability Database(https://nvd.nist.gov)

    :param product: search product, e.g. o:microsoft:windows_7
    :type product: str
    :param cve: search for one or more cve
    :type cve: str or list[str]
    :param frmt: output format. supported options: csv, html, json, xml, cveid, asciidoc
    :type frmt: str
    :param cpe: lookup complete CPE name for vulnerable configuration
    :type cpe: bool
    :param rank: lookup ranking of vulnerable configuration
    :type rank: bool
    :param capec: lookup capec for related cwes
    :type capec: bool
    :param api: cve-search instance to query
    :type api: str
    :return: formatted output
    """

    db = DatabaseLayer()
    query = Query(api=api)
    items = []
    kwargs = {
        'namelookup': cpe,
        'ranking':    rank,
        'capec':      capec,
        'product':    product,   # only used by html, otherwise ignored
        'cveids':     cve
    }  # only used by html, otherwise ignored

    # Fetch cves
    if product:
        items.extend(query.cveforcpe(product))
    if frmt:
        items.extend(query.search(frmt))
    if cve:
        for c in cve:
            items.append(query.cve(c))
    # Fetch extra info if needed
    for item in items:
        ranking = []
        for conf in item.vulnerable_configuration:
            if rank:  # Ranking lookup
                ranking = db.CPE.ranking(cpeid=conf)
                if rank and rank not in ranking:
                    ranking.append(rank)
        if rank:  # Ranking lookup
            item['ranking'] = ranking

    # Print output
    return _search.echo(output(items, frmt, **kwargs))


@search.group()
@click.pass_context
def _search(ctx):
    if ctx.invoked_subcommand is (None | 'search'):
        return search(ctx)
    elif ctx.invoked_subcommand is (search_cpe | 'cpe'):
        return search_cpe(ctx)
    elif ctx.invoked_subcommand is (search_irc | 'irc'):
        return search_irc(ctx)
    elif ctx.invoked_subcommand is (search_xmpp | 'xmpp'):
        return search_xmpp(ctx)
    elif ctx.invoked_subcommand is (search_fulltext | 'fulltext'):
        return search_fulltext(ctx)
    else:
        ...


if __name__ == '__main__':
    search(input)
