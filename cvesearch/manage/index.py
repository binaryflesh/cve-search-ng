#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Script to check and ensure that the recommended index are created as recommended.
#
# Software is free software released under the "GNU Affero General Public License v3.0"
#
# Copyright (c) 2014       psychedelys
# Copyright (c) 2015-2109  Pieter-Jan Moreels - pieter-jan@pidgey.net

# Imports
import pymongo
import click

from .. import DatabaseLayer
from . import _manage


db = DatabaseLayer()


def set_index(col, field, verbose):
    try:
        db.ensure_index(col, field)
        if verbose:
            _manage.echo('[+]Success to create index %s on %s' % (field, col))
    except Exception as e:
        _manage.echo('[-]Failed to create index %s on %s: %s' % (col, field, e))


@_manage.command()
@click.pass_context
@_manage.option('-v', '--verbose', type=click.BOOL, defaultvalue=True)
def manage_index(verbose):
    """Manage index

    :param verbose:
    :return:
    """
    set_index('cpe', 'id', verbose)
    set_index('cpeother', 'id', verbose)
    set_index('cves', 'id', verbose)
    set_index('cves', 'vulnerable_configuration', verbose)
    set_index('cves', 'Modified', verbose)
    set_index('cves', 'Published', verbose)
    set_index('cves', [("summary", pymongo.TEXT)], verbose)
    set_index('via4', 'id', verbose)
    set_index('capec', 'related_weakness', verbose)

    for index in db.VIA4.searchables():
        set_index('via4', index, False)
